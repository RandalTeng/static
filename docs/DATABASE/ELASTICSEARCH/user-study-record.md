API项目 v2.13的一个学习记录需求
==

背景简介
--

> 需要把用户播放过的一些目录课(包括系列课, 软件入门, 职业路径, 以及后续可能有的目录课)展示成单个目录  
> 同时, 在API上的显示目前状态下和其他端口并不同步, 主站/M站/客户端/小程序相关的显示都还是原来的单课显示  
> 这种情况下, 在保存视频对应的目录ID同时, 又需要保证通过目录ID查快速查到用户播放过的视频  
> 如果原纪录表结构可以较快的修改的话, 问题倒不是很大  
> 但是原学习记录表经过分表, 已经达到了一个比较大的量级, 总数据大概在6000w左右  
> 改表结构已经不太现实, 只能通过其他途径去实现

备选方案
--

1. 在ES里面重新构建用户学习相关的记录, 保留目录ID, 目录类型, 以及一些相关字段  
2. 重新构建一个MongoDB库, 重做整块相关内容

最终方案
--

``` text
这边最后选择的是方案1, 在ES重新构建用户学习相关的记录, 新的视频播放数据通过队列异步写入到ES
老数据通过跑脚本, 同步到ES
通过队列同步的数据信息, 学习记录本身的需求并没有高即时性, 可以接受ES搜索刷新的短时间延时
在数据库存储字段方面, 做了一些后续可能需要用于搜索的字段冗余

数据录入部分的相关内容, 由于新播放记录通过队列写入ES, 只需要在播放事件里面加入队列写入就行
APP显示部分则是通过ES聚合查询, 将相关的视频合并成一个目录
删除播放记录的时候, 通过ES查询到删除的视频ID, 再在数据库做删除标记(保证用户学习目录课的进度不会被删除), ES数据则直接删除

删除部分会有一定的不同步, 即用户删除目录后ES相关的数据不在存在
但是用户在视频列表进入目录列表的时候, 由于数据库数据做的软删除
比如一个目录课, 有10节视频, 用户在学习记录删除后, 进入目录里面看到的时候已XX节, 但是在学习记录却看不到记录
用户重新播放一个视频后, 在学习记录显示的确实一节已播放视频, 实际播放了XX+1节
这种情况可以通过同步已学列表, 或者在ES也做软删除, 在重新添加播放记录的时候查询所有目录ID为对应ID的记录做还原操作
这么做前期的相关工作又要重新改, 考虑到功能周期, 和产品沟通后, 这部分不一致可以暂时接受
```

另一种方案的构想
--

``` text
如果做MongoDB的话, ES方案的不同步数据可能会更方便修改, 目录下ID可以通过做子字段的方式在Mongo存储
相关的查询也可以通过简单的API查询, 不需要像ES做聚合查询麻烦
删除的时候Mongo标记软删除, 重新播放视频的时候激活就完事, 和MySQL操作比较类似, 比ES相对来说方便一点
可能是预想方案的时候个人不太成熟, 没有考虑全, 考虑到后续可能会在学习记录加搜索后, 单方面的去想ES在搜索方面的优势了
```
